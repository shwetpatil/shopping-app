# Cloudflare CDN Configuration
# Place this in Cloudflare dashboard or use Terraform/CLI

# Page Rules for API Gateway
rules:
  # Product endpoints - cacheable
  - pattern: "api.yourdomain.com/api/v1/products*"
    actions:
      cache_level: "cache_everything"
      edge_cache_ttl: 300  # Respect Cache-Control headers
      browser_cache_ttl: 300
      cache_by_device_type: false
    
  # Category endpoints - long cache
  - pattern: "api.yourdomain.com/api/v1/categories*"
    actions:
      cache_level: "cache_everything"
      edge_cache_ttl: 3600
      browser_cache_ttl: 3600
      cache_by_device_type: false
  
  # Cart endpoints - no cache (user-specific)
  - pattern: "api.yourdomain.com/api/v1/cart*"
    actions:
      cache_level: "bypass"
  
  # Orders - no cache (user-specific)
  - pattern: "api.yourdomain.com/api/v1/orders*"
    actions:
      cache_level: "bypass"
  
  # Auth endpoints - no cache
  - pattern: "api.yourdomain.com/api/v1/auth*"
    actions:
      cache_level: "bypass"

# Cache settings
cache_settings:
  # Respect origin headers
  respect_existing_headers: true
  
  # Cache query strings for products (filters, pagination)
  query_string_sort: true
  
  # Cache based on these query parameters
  cache_key_query_string:
    include:
      - "page"
      - "limit"
      - "categoryId"
      - "brandId"
      - "sort"
  
  # Ignore these query parameters for caching
  cache_key_query_string:
    ignore:
      - "utm_source"
      - "utm_medium"
      - "utm_campaign"

# Response headers to add
response_headers:
  - name: "X-CDN-Provider"
    value: "Cloudflare"
  - name: "X-Cache-Region"
    value: "$geo_country_code"

# Security settings
security:
  # Enable HTTPS only
  always_use_https: true
  
  # Minimum TLS version
  min_tls_version: "1.2"
  
  # Enable HTTP/2
  http2: true
  
  # Enable HTTP/3
  http3: true

# Performance optimizations
performance:
  # Enable Brotli compression
  brotli: true
  
  # Enable Rocket Loader (async JS)
  rocket_loader: false  # Disabled for MFE compatibility
  
  # Auto minify
  auto_minify:
    html: true
    css: true
    js: false  # Disabled - already minified by Next.js
  
  # Image optimization
  polish: "lossless"
  webp: true
  
  # Early Hints
  early_hints: true

# Cache purge configuration
purge:
  # Purge on these events
  auto_purge_on:
    - "product_update"
    - "category_update"
    - "deployment"
  
  # Purge patterns
  patterns:
    - "/api/v1/products/*"
    - "/api/v1/categories/*"
