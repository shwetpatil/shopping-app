# AWS CloudFront CDN Configuration
# Use with CloudFormation or Terraform

AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudFront Distribution for Shopping App API Gateway'

Resources:
  # Origin Access Identity for secure communication
  CloudFrontOAI:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: 'OAI for Shopping App'

  # Cache Policy for Products (5 min)
  ProductsCachePolicy:
    Type: AWS::CloudFront::CachePolicy
    Properties:
      CachePolicyConfig:
        Name: shopping-app-products-cache
        DefaultTTL: 300  # 5 minutes
        MaxTTL: 3600     # 1 hour
        MinTTL: 0
        ParametersInCacheKeyAndForwardedToOrigin:
          EnableAcceptEncodingGzip: true
          EnableAcceptEncodingBrotli: true
          QueryStringsConfig:
            QueryStringBehavior: whitelist
            QueryStrings:
              - page
              - limit
              - categoryId
              - brandId
              - sort
              - search
          HeadersConfig:
            HeaderBehavior: whitelist
            Headers:
              - Authorization
              - CloudFront-Viewer-Country
          CookiesConfig:
            CookieBehavior: none

  # Cache Policy for Categories (1 hour)
  CategoriesCachePolicy:
    Type: AWS::CloudFront::CachePolicy
    Properties:
      CachePolicyConfig:
        Name: shopping-app-categories-cache
        DefaultTTL: 3600   # 1 hour
        MaxTTL: 86400      # 24 hours
        MinTTL: 300        # 5 minutes
        ParametersInCacheKeyAndForwardedToOrigin:
          EnableAcceptEncodingGzip: true
          EnableAcceptEncodingBrotli: true
          QueryStringsConfig:
            QueryStringBehavior: none
          HeadersConfig:
            HeaderBehavior: none
          CookiesConfig:
            CookieBehavior: none

  # No Cache Policy (for cart, auth, orders)
  NoCachePolicy:
    Type: AWS::CloudFront::CachePolicy
    Properties:
      CachePolicyConfig:
        Name: shopping-app-no-cache
        DefaultTTL: 0
        MaxTTL: 0
        MinTTL: 0
        ParametersInCacheKeyAndForwardedToOrigin:
          EnableAcceptEncodingGzip: true
          QueryStringsConfig:
            QueryStringBehavior: all
          HeadersConfig:
            HeaderBehavior: whitelist
            Headers:
              - Authorization
              - Cookie
          CookiesConfig:
            CookieBehavior: all

  # Origin Request Policy
  APIOriginRequestPolicy:
    Type: AWS::CloudFront::OriginRequestPolicy
    Properties:
      OriginRequestPolicyConfig:
        Name: shopping-app-api-origin
        HeadersConfig:
          HeaderBehavior: whitelist
          Headers:
            - Authorization
            - CloudFront-Viewer-Country
            - User-Agent
            - Referer
        QueryStringsConfig:
          QueryStringBehavior: all
        CookiesConfig:
          CookieBehavior: all

  # CloudFront Distribution
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Comment: 'Shopping App API Gateway CDN'
        Enabled: true
        HttpVersion: http2and3
        PriceClass: PriceClass_100  # US, Canada, Europe
        
        # Default origin - API Gateway
        Origins:
          - Id: api-gateway
            DomainName: api.yourdomain.com
            CustomOriginConfig:
              HTTPPort: 80
              HTTPSPort: 443
              OriginProtocolPolicy: https-only
              OriginSSLProtocols:
                - TLSv1.2
              OriginReadTimeout: 30
              OriginKeepaliveTimeout: 5
        
        # Default behavior - no cache
        DefaultCacheBehavior:
          TargetOriginId: api-gateway
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
            - PUT
            - POST
            - PATCH
            - DELETE
          CachedMethods:
            - GET
            - HEAD
            - OPTIONS
          Compress: true
          CachePolicyId: !Ref NoCachePolicy
          OriginRequestPolicyId: !Ref APIOriginRequestPolicy
        
        # Products endpoints - cacheable
        CacheBehaviors:
          - PathPattern: /api/v1/products*
            TargetOriginId: api-gateway
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            Compress: true
            CachePolicyId: !Ref ProductsCachePolicy
            OriginRequestPolicyId: !Ref APIOriginRequestPolicy
          
          # Categories - long cache
          - PathPattern: /api/v1/categories*
            TargetOriginId: api-gateway
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            Compress: true
            CachePolicyId: !Ref CategoriesCachePolicy
            OriginRequestPolicyId: !Ref APIOriginRequestPolicy
          
          # Cart - no cache
          - PathPattern: /api/v1/cart*
            TargetOriginId: api-gateway
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
              - PUT
              - POST
              - PATCH
              - DELETE
            Compress: true
            CachePolicyId: !Ref NoCachePolicy
            OriginRequestPolicyId: !Ref APIOriginRequestPolicy
        
        # Custom error responses
        CustomErrorResponses:
          - ErrorCode: 404
            ResponseCode: 404
            ResponsePagePath: /errors/404.html
            ErrorCachingMinTTL: 300
          - ErrorCode: 500
            ResponseCode: 500
            ResponsePagePath: /errors/500.html
            ErrorCachingMinTTL: 0
          - ErrorCode: 503
            ResponseCode: 503
            ResponsePagePath: /errors/503.html
            ErrorCachingMinTTL: 0
        
        # Logging
        Logging:
          Bucket: your-cloudfront-logs.s3.amazonaws.com
          Prefix: shopping-app/
          IncludeCookies: false
        
        # TLS/SSL
        ViewerCertificate:
          AcmCertificateArn: arn:aws:acm:us-east-1:ACCOUNT:certificate/CERT-ID
          MinimumProtocolVersion: TLSv1.2_2021
          SslSupportMethod: sni-only
        
        # Aliases (custom domains)
        Aliases:
          - api.yourdomain.com

Outputs:
  DistributionId:
    Description: CloudFront Distribution ID
    Value: !Ref CloudFrontDistribution
    Export:
      Name: shopping-app-cdn-distribution-id
  
  DistributionDomainName:
    Description: CloudFront Distribution Domain Name
    Value: !GetAtt CloudFrontDistribution.DomainName
    Export:
      Name: shopping-app-cdn-domain
  
  DistributionURL:
    Description: CloudFront Distribution URL
    Value: !Sub 'https://${CloudFrontDistribution.DomainName}'
